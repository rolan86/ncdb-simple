{% extends "base.html" %}

{% block content %}
<div x-data="{ 
    selectedTable: '', 
    viewMode: 'spreadsheet',
    tableData: [],
    hot: null,
    async loadTableData() {
        if (!this.selectedTable) return;
        try {
            const response = await fetch(`/get_table_data/${this.selectedTable}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            this.tableData = await response.json();
            console.log('Loaded table data:', this.tableData);
            this.initSpreadsheet();
        } catch (e) {
            console.error('Error loading table data:', e);
            alert('Error loading table data. Please check the console for more information.');
        }
    },
    initSpreadsheet() {
        console.log('Initializing spreadsheet');
        if (!this.selectedTable || !this.tableData || this.tableData.length === 0) {
            console.log('No data to initialize spreadsheet');
            document.getElementById('spreadsheet').innerHTML = '<p>No data available for this table.</p>';
            return;
        }
        
        const container = document.getElementById('spreadsheet');
        if (this.hot) {
            this.hot.destroy();
        }

        console.log('First row of data:', this.tableData[0]);
        const columns = Object.keys(JSON.parse(this.tableData[0].user_data)).map(key => ({
            data: `user_data.${key}`,
            title: key.charAt(0).toUpperCase() + key.slice(1)
        }));

        columns.unshift({ data: 'id', title: 'ID', readOnly: true });

        console.log('Columns:', columns);

        this.hot = new Handsontable(container, {
            data: this.tableData.map(item => ({
                id: item.id,
                user_data: JSON.parse(item.user_data)
            })),
            columns: columns,
            rowHeaders: true,
            colHeaders: columns.map(col => col.title),
            width: '100%',
            height: 300,
            licenseKey: 'non-commercial-and-evaluation'
        });

        console.log('Handsontable initialized');
    },    

    async updateTableData(rowData) {
        try {
            const response = await fetch(`/update_table_data/${this.selectedTable}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: rowData.id,
                    user_data: JSON.stringify(rowData.user_data)
                }),
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            this.loadTableData();
        } catch (e) {
            console.error('Error updating table data:', e);
            alert('Error updating table data. Please check the console for more information.');
        }
    }
}">    
    <h1 class="text-3xl font-bold mb-6">Welcome, {{ current_user.username }}!</h1>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Select a Table</h2>
        <select x-model="selectedTable" @change="loadTableData()" class="w-full p-2 border rounded">
            <option value="">Choose a table</option>
            {% for table_name, description in tables.items() %}
            <option value="{{ table_name }}">{{ description }}</option>
            {% endfor %}
        </select>
    </div>

    <div x-show="selectedTable" class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 x-text="selectedTable" class="text-2xl font-bold"></h2>
            <div class="flex space-x-2">
                <button @click="viewMode = 'spreadsheet'; $nextTick(() => initSpreadsheet())" :class="{ 'bg-blue-500 text-white': viewMode === 'spreadsheet', 'bg-gray-200': viewMode !== 'spreadsheet' }" class="px-4 py-2 rounded">Spreadsheet</button>
                <button @click="viewMode = 'list'" :class="{ 'bg-blue-500 text-white': viewMode === 'list', 'bg-gray-200': viewMode !== 'list' }" class="px-4 py-2 rounded">List</button>
                <button @click="viewMode = 'form'" :class="{ 'bg-blue-500 text-white': viewMode === 'form', 'bg-gray-200': viewMode !== 'form' }" class="px-4 py-2 rounded">Form</button>
            </div>
        </div>

        <div x-show="viewMode === 'spreadsheet'">
            <div id="spreadsheet"></div>
        </div>

        <div x-show="viewMode === 'list'">
            <ul>
                <template x-for="item in tableData" :key="item.id">
                    <li>
                        <strong x-text="`ID: ${item.id}`"></strong>
                        <span x-text="item.user_data"></span>
                    </li>
                </template>
            </ul>
        </div>

        <div x-show="viewMode === 'form'">
            <form @submit.prevent="updateTableData({ id: null, user_data: $event.target.formData.value })">
                <div>
                    <label for="formData" class="block text-sm font-medium text-gray-700">Data (JSON format):</label>
                    <textarea id="formData" name="formData" rows="4" class="mt-1 block w-full border rounded-md shadow-sm"></textarea>
                </div>
                <button type="submit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Submit</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
{% endblock %}
