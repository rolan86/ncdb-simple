{% extends "base.html" %}
{% block content %}

<div x-data="{ 
    selectedTable: '', 
    viewMode: 'spreadsheet',
    tableData: [],
    formFields: [],
    formData: {},
    async loadTableData() {
        if (!this.selectedTable) return;
        try {
            const response = await fetch(`/get_table_data/${this.selectedTable}/${this.viewMode}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (this.viewMode === 'form') {
                this.formFields = data;
                this.initForm();
            } else {
                this.tableData = data;
            }
            if (this.viewMode === 'spreadsheet') {
                this.renderSpreadsheet();
            } else if (this.viewMode === 'list') {
                this.renderList();
            }
        } catch (e) {
            console.error('Error loading table data:', e);
            alert('Error loading table data. Please check the console for more information.');
        }
    },
    renderSpreadsheet() {
        const container = document.getElementById('spreadsheet');
        container.innerHTML = '';
        if (!this.tableData || this.tableData.length === 0) {
            container.innerHTML = '<p>No data available for this table.</p>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'w-full border-collapse border border-gray-300';

        // Create header
        const header = table.createTHead();
        const headerRow = header.insertRow();
        const userData = JSON.parse(this.tableData[0].user_data);
        ['id', ...Object.keys(userData)].forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            th.className = 'border border-gray-300 p-2 bg-gray-100';
            headerRow.appendChild(th);
        });

        // Create body
        const body = table.createTBody();
        this.tableData.forEach(row => {
            const tr = body.insertRow();
            const userData = JSON.parse(row.user_data);
            
            // Add id cell
            const idCell = tr.insertCell();
            idCell.textContent = row.id;
            idCell.className = 'border border-gray-300 p-2';
            
            // Add other cells
            Object.entries(userData).forEach(([key, value]) => {
                const td = tr.insertCell();
                td.textContent = value;
                td.className = 'border border-gray-300 p-2';
                td.contentEditable = true;
                td.addEventListener('blur', () => this.updateCell(row.id, key, td.textContent));
            });
        });

        container.appendChild(table);
    },
    renderList() {
        const container = document.getElementById('list-view');
        container.innerHTML = '';
        if (!this.tableData || this.tableData.length === 0) {
            container.innerHTML = '<p>No data available for this table.</p>';
            return;
        }
        const ul = document.createElement('ul');
        ul.className = 'space-y-4';
        this.tableData.forEach(row => {
            const li = document.createElement('li');
            li.className = 'border p-4 rounded';
            const userData = JSON.parse(row.user_data);
            li.innerHTML = `
                <p><strong>ID:</strong> ${row.id}</p>
                ${Object.entries(userData).map(([key, value]) => `
                    <p><strong>${key}:</strong> ${value}</p>
                `).join('')}
            `;
            ul.appendChild(li);
        });
        container.appendChild(ul);
    },
    updateCell(rowId, column, value) {
        this.updateTableData(rowId, column, value);
    },
    initForm() {
        this.formData = {};
        this.formFields.forEach(field => {
            this.formData[field] = '';
        });
    },
    async submitForm() {
        try {
            const response = await fetch(`/add_table_data/${this.selectedTable}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_data: JSON.stringify(this.formData)
                }),
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            alert('Data added successfully!');
            this.loadTableData();
        } catch (e) {
            console.error('Error adding table data:', e);
            alert('Error adding table data. Please check the console for more information.');
        }
    },
    async updateTableData(rowId, column, value) {
        try {
            const rowData = this.tableData.find(row => row.id === rowId);
            if (!rowData) throw new Error('Row not found');
            
            const userData = JSON.parse(rowData.user_data);
            userData[column] = value;

            const response = await fetch(`/update_table_data/${this.selectedTable}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: rowId,
                    user_data: JSON.stringify(userData)
                }),
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            // Update local data
            rowData.user_data = JSON.stringify(userData);
        } catch (e) {
            console.error('Error updating table data:', e);
            alert('Error updating table data. Please check the console for more information.');
        }
    }
}">
    <h1 class="text-3xl font-bold mb-6" id="welcome">Welcome, {{ current_user.username }}!</h1>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Select a Table</h2>
        <select x-model="selectedTable" @change="loadTableData()" class="w-full p-2 border rounded">
            <option value="">Choose a table</option>
            {% for table_name, description in tables.items() %}
                <option value="{{ table_name }}">{{ description }}</option>
            {% endfor %}
        </select>
    </div>

    <div x-show="selectedTable" class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold" x-text="selectedTable"></h2>
            <div class="flex space-x-2">
                <button @click="viewMode = 'spreadsheet'; loadTableData()" :class="{'bg-blue-500 text-white': viewMode === 'spreadsheet'}" class="px-4 py-2 rounded">Spreadsheet</button>
                <button @click="viewMode = 'list'; loadTableData()" :class="{'bg-blue-500 text-white': viewMode === 'list'}" class="px-4 py-2 rounded">List</button>
                <button @click="viewMode = 'form'; loadTableData()" :class="{'bg-blue-500 text-white': viewMode === 'form'}" class="px-4 py-2 rounded">Form</button>
            </div>
        </div>

        <div x-show="viewMode === 'spreadsheet'">
            <div id="spreadsheet" class="overflow-x-auto"></div>
        </div>

        <div x-show="viewMode === 'list'">
            <div id="list-view" class="space-y-4"></div>
        </div>

        <div x-show="viewMode === 'form'">
            <form @submit.prevent="submitForm()" class="space-y-4">
                <template x-for="field in formFields" :key="field">
                    <div>
                        <label :for="field" class="block text-sm font-medium text-gray-700" x-text="field"></label>
                        <input :id="field" type="text" x-model="formData[field]" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </template>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Submit</button>
            </form>
        </div>
    </div>
</div>

{% endblock %}
